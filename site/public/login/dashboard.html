<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenit Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="./styleChart.css">
    <script src="../js/funcoes.js"></script>
    <script src="./alerta.js"></script>
    <script src="../arduino_api_v3/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>
    <div class="divHeader">
        <div class="divLogo">
            <a href="main.html" id="link"> <img src="../assets/imgs/logo-1.png" alt="Logo Zenit" id="imgHeaderLogo">
            </a>
        </div>
        <a href="CalculadorLogin.html">
            <h4 id="liCalGanhos">Calcular Ganhos</h4>
        </a>
        <a href="nossoProdutoLogin.html">
            <h4 id="liNossoProduto">Nosso Produto</h4>
        </a>
        <a href="QuemSomosLogin.html">
            <h4 id="liQuemSomos">Quem Somos</h4>
        </a>
        <a href="dashboard.html">
            <h4 id="liDashboard">Dashboard</h4>
        </a>
        <div class="divPerfil">
            <img id="imgHeader" src="../assets/imgs/icon-user-transparente.png" alt="">
            <a href="perfil.html">
                <h4>Perfil</h4>
            </a>
            <a href="../index.html">
                <h4 id="liPerfil">Logout</h4>
            </a>
        </div>
    </div>


    <div id="telaModal">
        <div class="dash">
            <div id="alerta">
            </div>
            <!-- <select class="selectGrafico" onchange="exibirTransf(this.value)">
                <option value="1">Transformador 1</option>
                <option value="2">Transformador 2</option>
                <option value="3">Transformador 3</option>
                <option value="4">Transformador 4</option>
            </select> -->
            <!-- <div class="btns-dash"> -->
            <!-- O gráfico é chamado de acordo com o id (fk_transformador) do banco  -->
            <button class="buttonGrafico" onclick="exibirTransf(1), intervaloTransf1()" id="btnTransf1">Transformador
                1</button>
            <button class="buttonGrafico" onclick="exibirTransf(2), intervaloTransf2()" id="btnTransf2">Transformador
                2</button>
            <button class="buttonGrafico" onclick="exibirTransf(3), intervaloTransf3()" id="btnTransf3">Transformador
                3</button>
            <button class="buttonGrafico" onclick="exibirTransf(4), intervaloTransf4()" id="btnTransf4">Transformador
                4</button>
            <div id="graficos">
                <div id="grafico1" class="display-block">
                    <h3 class="tituloGraficos">
                        <span id="tituloTransformador1">Transformador 1</span>
                    </h3>
                    <div class="grafico">
                        <canvas id="graficoTransformador1"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura1"></p>
                    </div>
                </div>

                <div id="grafico2" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloTransformador2">Transformador 2</span>
                    </h3>
                    <div class="grafico">
                        <canvas id="graficoTransformador2"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura2"></p>
                    </div>
                </div>

                <div id="grafico3" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloTransformador3">Transformador 3</span>
                    </h3>
                    <div class="grafico">
                        <canvas id="graficoTransformador3"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura3"></p>
                    </div>
                </div>

                <div id="grafico4" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloTransformador4">Transformador 4</span>
                    </h3>
                    <div class="grafico">
                        <canvas id="graficoTransformador4"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura4"></p>
                    </div>
                </div>


            </div>

            <div id="regua"></div>
            <div id="kpis">
                <span>20</span>
                <span>45</span>
                <span>60</span>
                <span>80</span>
                <span>100</span>
            </div>
            
        </div>
        <div class="divKPI" id="divKpiGeral">

            <div class="miniKPI">
                <canvas id="graficoKpi" width="200px"></canvas>
            </div>
            <div class="listaKpi" id="listaTransformadores">
                <span id="visaoGeral">
                    <div class="card">
                        <h1>Transformador 1</h1>
                        <div class="temperatura">
                            <p id="temp_transf_1" class="tempExibida">-°C</p>
                        </div>
                        <div class="cor-alerta" id="card_1"></div>
                    </div>
                    <div class="card">
                        <h1>Transformador 2</h1>
                        <div class="temperatura">
                            <p id="temp_transf_2" class="tempExibida">-°C</p>
                        </div>
                        <div class="cor-alerta" id="card_2"></div>
    
                    </div>
                    <div class="card">
                        <h1>Transformador 3</h1>
                        <div class="temperatura">
                            <p id="temp_transf_3" class="tempExibida">-°C</p>
                        </div>
                        <div class="cor-alerta ideal" id="card_3"></div>
                    </div>
                    <div class="card">
                        <h1>Transformador 4</h1>
                        <div class="temperatura">
                            <p id="temp_transf_4" class="tempExibida">-°C</p>
                        </div>
                        <div class="cor-alerta" id="card_4"></div>
                    </div>
                </span>
            </div>
        </div>

    </div>


    </div>
    </div>

    <div class="divFooter">
        <div class="content">
            <img src="../assets/imgs/logo-1.png" alt="Logo Footer" id="imgFooterLogo">
            <div class="divColuna">
                <h5>INÍCIO</h5>
                <ul id="listaFooterHome">
                    <li><a href="main.html"> Home </a></li>
                    <li><a href="dashboard.html"> Dashboard </a></li>
                    <li><a href="cadastrarFuncionario.html"> Cadastrar Funcionário </a></li>
                    <li><a href="perfil.html"> Perfil </a></li>
                </ul>
            </div>
            <div class="divColuna">
                <h5>FALE CONOSCO</h5>
                <ul id="listaFooterFaleConosco">
                    <li><a href="nossoProdutoLogin.html"> Informações da Empresa </a></li>
                    <li><a href="QuemSomosLogin.html"> Sobre nós </a></li>
                </ul>
            </div>
            <div class="divColuna">
                <h5>SUPORTE</h5>
                <ul id="listaFooterSuporte">
                    <li><a href="https://mail.google.com"> Zeniteletrica@gmail.com </a></li>
                    <li><a href="https://zeniteletrica.atlassian.net/servicedesk/customer/portal/1"> Central de ajuda
                        </a></li>
                </ul>
            </div>
            <div class="divColunaRedes">
                <a href="https://www.instagram.com/"><img src="../assets/imgs/instagram-icon.svg" alt="icon - instagram"
                        class="iconsFooter"></a>
                <a href="https://www.linkedin.com"><img src="../assets/imgs/linkedin-icon.svg" alt="icon - linkedin"
                        class="iconsFooter"></a>
                <a href="https://github.com/npz12/Zenit-Sp2.git"><img src="../assets/imgs/github-icon-footer.svg"
                        alt="icon - github" class="iconsFooter"></a>
            </div>
        </div>

        <div id="zenitFooter">
            <h4>© 2023 Copyright Zenit</h4>
        </div>
    </div>
</body>

</html>
<script>

    let tempoIntervalo = 6000;
    let fkEmpresa = sessionStorage.ID_EMPRESA;
    function atualizacaoPeriodica() {
        obterdados(1);
        obterdados(2);
        obterdados(3);
        obterdados(4);
        setTimeout(atualizacaoPeriodica, tempoIntervalo);
    }
    atualizacaoPeriodica()


    const kpiGeral = document.getElementById('graficoKpi');

    Chart.defaults.color = "#000";


    function arredondar(dateTimeValue) {
        return (dateTimeValue < 10) ? '0' + dateTimeValue.toString() : dateTimeValue.toString();
    }

    let proximaAtualizacao;

    window.onload = obterDadosGraficos(), obterDadosKpi(1, fkEmpresa);


    function obterDadosGraficos() {
        obterDadosGrafico(1)
        obterDadosGrafico(2)
        obterDadosGrafico(3)
        obterDadosGrafico(4)
    }

    var dadosKpi = [0, 0, 0];
    let atualizarTransformador = setInterval(() => obterDadosKpi(1, fkEmpresa), tempoIntervalo)
    function intervaloTransf1() {
        clearInterval(atualizarTransformador)
        obterDadosKpi(1, fkEmpresa)
        atualizarTransformador = setInterval(() => obterDadosKpi(1, fkEmpresa), tempoIntervalo)
    }
    function intervaloTransf2() {
        clearInterval(atualizarTransformador)
        obterDadosKpi(2, fkEmpresa)
        atualizarTransformador = setInterval(() => obterDadosKpi(2, fkEmpresa), tempoIntervalo)
    }
    function intervaloTransf3() {
        clearInterval(atualizarTransformador)
        obterDadosKpi(3, fkEmpresa)
        atualizarTransformador = setInterval(() => obterDadosKpi(3, fkEmpresa), tempoIntervalo)
    }
    function intervaloTransf4() {
        clearInterval(atualizarTransformador)
        obterDadosKpi(4, fkEmpresa)
        atualizarTransformador = setInterval(() => obterDadosKpi(4, fkEmpresa), tempoIntervalo)
    }



    function alterarTitulo(idTransformador) {
        var tituloTransformador = document.getElementById(`tituloTransformador${idTransformador}`)
        tituloTransformador.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Transformador " + idTransformador + "</span>"
    }

    function exibirTransf(idTransformador) {
        let todosOsGraficos = document.getElementById("graficos")
        console.log(idTransformador)

        for (i = 1; i <= todosOsGraficos.childElementCount; i++) {
            // exibindo - ou não - o gráfico
            let elementoAtual = document.getElementById(`grafico${i}`)
            let kpiAtual = document.getElementById(``)

            if (elementoAtual.classList.contains("display-block")) {
                elementoAtual.classList.remove("display-block")
            }
            elementoAtual.classList.add("display-none")
        }

        let graficoExibir = document.getElementById(`grafico${idTransformador}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

    }


    function obterDadosGrafico(idTransformador) {

        // alterarTitulo(idTransformador)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idTransformador}/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idTransformador);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    let plotarDadosKpi = {
        type: 'pie',
        data: {
            labels: [`Ideal(${dadosKpi[0]})`, `Alerta(${dadosKpi[1]})`, `Critico(${dadosKpi[2]})`],
            datasets: [{
                data: dadosKpi,
                borderWidth: 1,
                borderColor: "#fff",
                backgroundColor: ["#44ff44", "#ffff44", "#ff4444"]
            }]
        },
        options: {
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 10
                        }
                    },
                    title: {
                        display: true,
                        text: 'Indicadores'
                    },
                }
            },

        }
    };

    let registros = [];
    let kpi = new Chart(kpiGeral, plotarDadosKpi);
    function obterDadosKpi(idTransformador) {

        fetch(`/medidas/ultimas-kpis/${idTransformador}/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    console.log(resposta[0])

                    dadosKpi[0] = resposta[0].ideal;
                    dadosKpi[1] = resposta[0].alerta;
                    dadosKpi[2] = resposta[0].critico;

                    plotarDadosKpi.data.labels = [`Ideal(${dadosKpi[0]})`, `Alerta(${dadosKpi[1]})`, `Critico(${dadosKpi[2]})`];
                    kpi.update();


                    // plotarGrafico(resposta, idTransformador);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    };

    function plotarGrafico(resposta, idTransformador) {


        let labels = [];

        let dados = {
            labels: labels,
            datasets: [
                {
                    label: 'Temperatura( °C )',
                    data: [],
                    fill: false,
                    borderColor: "#4472c4",
                    backgroundColor: "#4472c4",
                    tension: 0.1
                }]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.temperatura);
        }

        const config = {
            type: 'line',
            data: dados,
        };


        let myChart = new Chart(
            document.getElementById(`graficoTransformador${idTransformador}`),
            config
        );

        setTimeout(() => atualizarGrafico(idTransformador, dados, myChart, kpi), tempoIntervalo);
    }


    function atualizarGrafico(idTransformador, dados, myChart, kpi) {


        fetch(`/medidas/tempo-real/${idTransformador}/${fkEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {



                    let avisoCaptura = document.getElementById(`avisoCaptura${idTransformador}`)
                    avisoCaptura.innerHTML = ""


                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {

                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        // console.log(dados.datasets[0].data.length)
                        // console.log("Horário do novo dado capturado:")
                        // console.log(novoRegistro[0].momento_grafico)
                        // console.log("Horário do último dado capturado:")
                        // console.log(dados.labels[dados.labels.length - 1])
                        // console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idTransformador, dados, myChart, kpi), tempoIntervalo);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idTransformador, dados, myChart, kpi), tempoIntervalo);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


</script>